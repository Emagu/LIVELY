機構編號:<%= value.firm.no %><br>
機構名稱:<%= value.firm.title %><br>
機構所在縣市:<a id="firm_city"></a><br>
機構所在鄉鎮:<a id="firm_ctry"></a><br>
機構地址:<%= value.firm.addr %><br>
機構市話:<%= value.firm.phone %><br>
機構傳真:<%= value.firm.fax %><br>
平均價位:<%= value.firm.price%><br>
<p id="firm_type"></p>
<p id="firm_type2"></p>
<p id="firm_level"></p>
<div id="firmView"></div>
<div id="guestBook" align='center'>
    <div class="guestHead">
        <h1>留言板</h1>
    </div>
    <% value.guestBook.forEach(function(gb){ %>
        <div class="guestFloor">
            <p>留言者:<%= gb.Name%></p>
            <p>留言時間:<%= gb.time%></p>
            <p>內容:</p>
            <textarea disabled id="data_<%= gb.NO%>" style="resize: none;overflow: auto;"rows="10" cols="50"></textarea><br>
            <p>回覆:<% if(gb.replyTime!=null && gb.replyStatus==1){%><a align="right">回覆時間:<%= gb.replyTime%></a><% }%></p>
            <textarea disabled id="reply_<%= gb.NO%>" style="resize: none;overflow: auto;"rows="10" cols="50"></textarea><br>
            <% if(value.isManger){ %>
                <% if(gb.reply!=null){%>
                    <button id="reply_btn_<%= gb.NO%>" onclick="editReply(<%= gb.NO%>)">編輯</button>
                    <button id="delete_btn_<%= gb.NO%>" onclick="deleteReply(<%= gb.NO%>)">刪除</button>
                    <button id="canncel_btn_<%= gb.NO%>" style="display:none" onclick="canncelReply(<%= gb.NO%>,'編輯')">取消</button>
                <% }else{%>
                    <button id="reply_btn_<%= gb.NO%>" onclick="editReply(<%= gb.NO%>)">回覆</button>
                    <button id="canncel_btn_<%= gb.NO%>" style="display:none" onclick="canncelReply(<%= gb.NO%>,'回覆')">取消</button>
                <% }%>
            <% } %>
            <br>
        </div>
    <% }); %>
    <div class="guestComment">
        <textarea id="CommentMessage" style="resize: none;overflow: auto;"rows="10" cols="50"></textarea>
        <button onclick="commentSumit()">發送</button>
    </div>
</div>
<script>
    $(document).ready(function(){
        var typeA = ["安養機構","養護機構","長期照顧中心","護理之家"];
        var type2A = ["A.社區整合服務中心","B.複合型日間照護中心","C.巷弄長照站"];
        var level = ["優","甲","乙","丙"];
        $("#firm_type").html("機構功能分類:" + typeA[<%= value.firm.type%>]);
        $("#firm_type2").html("長照2.0類型分類:"+type2A[<%= value.firm.type2%>]);
        $("#firm_level").html("政府評鑑:"+level[<%= value.firm.level%>]);
        $("#firmView").html(decodeURIComponent('<%= value.firm.html %>'));
        $("#firm_city").html(TAR.getCity(<%= value.firm.city %>));
        $("#firm_ctry").html(TAR.getCountry(<%= value.firm.city %>,<%= value.firm.ctry %>));
        <% value.guestBook.forEach(function(gb){ %>
            <% if(gb.data!=null){%>
                $("#data_<%= gb.NO%>").val(decodeURIComponent('<%= gb.data%>'));
            <% }%>
            <% if(gb.reply!=null && gb.replyStatus==1){ %>
                $("#reply_<%= gb.NO%>").val(decodeURIComponent('<%= gb.reply%>'));
            <% } %>
        <% }); %>
    });           
    function commentSumit(){
        $.post("/firm/commentSumit",{
            Message:encodeURIComponent($("#CommentMessage").val()),
            firmNO:<%= value.firm.ID%>
        },function(status){
            if(status == "success") location.reload();
            else toastr.error( '',status, {
                    "positionClass": "toast-bottom-full-width",
    				"timeOut": "3000",
    				"closeButton": true
    			});
        },"html");
    }
    function canncelReply(commentNO,buttonText){
        $("#canncel_btn_"+commentNO).css("display","none");
        $("#delete_btn_"+commentNO).css("display","block");
        $("#reply_"+commentNO).attr("disabled",true); 
        $("#reply_btn_"+commentNO).text(buttonText);
    }
    function editReply(commentNO){
        if($("#reply_"+commentNO).attr("disabled")!=null){
            $("#reply_"+commentNO).attr("disabled",false); 
            $("#reply_btn_"+commentNO).text("送出");
            $("#delete_btn_"+commentNO).css("display","none");
            $("#canncel_btn_"+commentNO).css("display","block");
        }else{
            $.post("/firm/reply",{
                Message:encodeURIComponent($("#reply_"+commentNO).val()),
                GusetBookNO:commentNO
            },function(status){
                if(status == "success") location.reload();
                else toastr.error( '',status, {
                        "positionClass": "toast-bottom-full-width",
        				"timeOut": "3000",
        				"closeButton": true
        			});
            },"html");
        }
    }
    function deleteReply(commentNO){
        $.post("/firm/deleteReply",{
            GusetBookNO:commentNO
        },function(status){
            if(status == "success") location.reload();
            else toastr.error( '',status, {
                    "positionClass": "toast-bottom-full-width",
    				"timeOut": "3000",
    				"closeButton": true
    			});
        },"html");
    }
</script>